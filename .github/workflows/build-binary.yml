name: Build binary

on:
  pull_request:
    branches: [ "main" ]
  #workflow_dispatch: # TODO: replace ${{github.head_ref}} for workflow_dispatch...

jobs:
  build:
    runs-on: ${{ matrix.platform.os }}
    strategy:
      fail-fast: false
      matrix:
        platform:
        - {
            os: windows-latest,
            rid: win-x64
          },
        - {
            os: ubuntu-latest,
            rid: linux-x64
          }
    steps:
      - name: Echo branch name
        run: echo ${{github.head_ref}} 

      - name: Checkout current repo
        uses: actions/checkout@v3
        with:
          ref: ${{github.head_ref}}
          path: storage

      - name: Install Ninja
        uses: seanmiddleditch/gha-setup-ninja@master

      - name: Checkout cpu_features.NET
        uses: actions/checkout@v3
        with:
          repository: toor1245/cpu_features.NET
          path: cpu_features.NET

      - name: Cache CMake project
        id: project
        uses: actions/cache@v3
        with:
          path: cpu_features.NET/cmake-build-release
          key: project-${{ hashFiles('./cpu_features.NET/src/*') }}

      - name: Configure CMake project
        if: steps.project.outputs.cache-hit != 'true'
        run: |
          cd cpu_features.NET
          ${{ runner.os!='Windows'&&'sudo '||''}}cmake . -Bcmake-build-release -DCMAKE_BUILD_TYPE=Release -GNinja -DCMAKE_C_COMPILER=clang -DCMAKE_CXX_COMPILER=clang++

      - name: Build CMake project
        run: |
          cd cpu_features.NET
          ${{ runner.os!='Windows'&&'sudo '||''}}cmake --build cmake-build-release --config=Release

      # TODO: make it depend on version?
      - name: Copy dll
        shell: bash
        run: |
          mkdir -p ./storage/runtimes/${{ matrix.platform.rid }}/native/
          cp ./cpu_features.NET/cmake-build-release/lib/* ./storage/runtimes/${{ matrix.platform.rid }}/native/

      - name: Git Push
        run: |
          cd storage
          git status
          git config user.name "GitHub Actions Bot"
          git config user.email "<>"
          git add .
          git commit -m "Add ${{ matrix.platform.rid }} binary"
          git push origin ${{github.head_ref}}
